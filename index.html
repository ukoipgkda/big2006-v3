<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #020617; color: white; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 2rem; }
        .input-box { background: #0f172a; border: 1px solid #334155; border-radius: 1rem; padding: 1rem; width: 100%; color: white; outline: none; transition: 0.3s; }
        .input-box:focus { border-color: #fbbf24; }
        .img-frame { width: 150px; height: 190px; border: 3px solid #fbbf24; border-radius: 1.5rem; object-fit: cover; background: #1e293b; }
        input[type=range] { accent-color: #fbbf24; cursor: pointer; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading" class="fixed inset-0 bg-black/80 z-[100] hidden flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-yellow-500 font-bold text-xs uppercase tracking-widest">Memproses Permintaan...</p>
    </div>

    <div id="screen-login" class="max-w-md mx-auto mt-20 glass p-10 text-center">
        <h1 class="text-3xl font-black text-yellow-500 mb-8 uppercase italic">e-BIG PORTAL</h1>
        <div class="space-y-4 text-left">
            <input type="text" id="user-id" class="input-box" placeholder="IC Pelajar / Email Pensyarah">
            <input type="password" id="user-pass" class="input-box" placeholder="Password (Pensyarah Sahaja)">
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="auth('student')" class="bg-blue-600 p-4 rounded-xl font-bold uppercase text-xs shadow-lg hover:bg-blue-500">Log Pelajar</button>
                <button onclick="auth('lecturer')" class="bg-indigo-600 p-4 rounded-xl font-bold uppercase text-xs shadow-lg hover:bg-indigo-500">Log Pensyarah</button>
            </div>
        </div>
    </div>

    <div id="screen-student" class="max-w-4xl mx-auto hidden glass p-10 mt-10">
        <h2 class="text-xl font-black text-yellow-500 mb-8 uppercase border-l-4 border-yellow-500 pl-4">Kemaskini Profil Pelajar</h2>
        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
            <div class="md:col-span-4 flex flex-col items-center gap-4">
                <img id="profile-pic" src="https://www.w3schools.com/howto/img_avatar.png" class="img-frame shadow-2xl">
                <input type="text" id="std-img-url" class="input-box text-[10px]" oninput="document.getElementById('profile-pic').src=this.value" placeholder="Link Gambar Profil (Drive)">
            </div>
            <div class="md:col-span-8 space-y-4 text-left">
                <div class="grid grid-cols-2 gap-4">
                    <select id="std-siri" class="input-box text-xs font-bold uppercase"><option value="4">SIRI 4</option><option value="2">SIRI 2</option></select>
                    <select id="std-kump" class="input-box text-xs font-bold uppercase">
                        <option value="GREY">GREY</option><option value="JINGGA">JINGGA</option><option value="KUNING">KUNING</option><option value="UNGU">UNGU</option>
                        <option value="BIRU GELAP">BIRU GELAP</option><option value="BIRU">BIRU</option><option value="PINK">PINK</option><option value="COKLAT">COKLAT</option>
                        <option value="MERAH">MERAH</option><option value="HIJAU">HIJAU</option>
                    </select>
                </div>
                <input type="number" id="std-no" class="input-box" placeholder="No. Dalam Kumpulan">
                <input type="text" id="std-alahan" class="input-box" placeholder="Jenis Alahan (Jika Tiada Tulis 'Tiada')">
                <input type="text" id="std-ubat" class="input-box" placeholder="Senarai Ubat (Jika Tiada Tulis 'Tiada')">
                <input type="text" id="std-sos" class="input-box" placeholder="No. Tel Waris / Kecemasan">
                <button onclick="updateStudent()" class="w-full bg-green-600 p-5 rounded-2xl font-black uppercase shadow-xl hover:bg-green-500 mt-4">SIMPAN MAKLUMAT</button>
            </div>
        </div>
    </div>

    <div id="screen-lecturer" class="max-w-5xl mx-auto hidden glass p-10 mt-10">
        <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-6">
            <h2 class="text-xl font-black text-yellow-500 uppercase">Panel Penilai: <span id="lec-name-disp" class="text-white"></span></h2>
            <button onclick="location.reload()" class="bg-red-600 px-4 py-2 rounded-xl font-bold text-[10px] uppercase hover:bg-red-500">Log Keluar</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 flex flex-col space-y-4">
                
                <div class="bg-slate-800/50 p-6 rounded-2xl border border-white/5 shadow-lg">
                    <h3 class="text-sm font-bold text-yellow-500 uppercase mb-4 border-l-4 border-yellow-500 pl-3">Tapis Pelajar</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold opacity-50 uppercase block mb-1">SIRI BIG</label>
                            <select id="filter-siri" onchange="filterStudents()" class="input-box text-xs font-bold uppercase">
                                <option value="ALL">SEMUA SIRI</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold opacity-50 uppercase block mb-1">KELAS</label>
                                <select id="filter-kelas" onchange="filterStudents()" class="input-box text-xs font-bold uppercase">
                                    <option value="ALL">SEMUA KELAS</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold opacity-50 uppercase block mb-1">KUMPULAN</label>
                                <select id="filter-kump" onchange="filterStudents()" class="input-box text-xs font-bold uppercase">
                                    <option value="ALL">SEMUA KUMPULAN</option>
                                </select>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-white/10 mt-4">
                            <label class="text-[10px] font-bold text-yellow-500 uppercase block mb-1">PILIH PELAJAR UNTUK DINILAI</label>
                            <select id="sel-std" onchange="loadStudentMarking()" class="input-box text-xs font-bold uppercase bg-blue-900/30 border-blue-500/50">
                                <option value="">-- PILIH PELAJAR --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col items-center mt-4">
                    <img id="lec-std-pic" src="https://www.w3schools.com/howto/img_avatar.png" class="img-frame shadow-2xl">
                    <div id="lec-std-info" class="text-center mt-3 hidden">
                        <p id="info-ic" class="text-xs font-bold text-gray-400"></p>
                        <p id="info-kump" class="text-[10px] font-black uppercase text-indigo-400 mt-1"></p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7 space-y-6 hidden" id="marking-panel">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900/50 p-4 rounded-xl">
                        <label class="text-[10px] font-bold opacity-50 uppercase">KUIZ 1 (5%)</label>
                        <input type="number" id="m-k1" class="w-full bg-transparent text-lg font-bold outline-none mt-1" placeholder="0">
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-xl">
                        <label class="text-[10px] font-bold opacity-50 uppercase">KUIZ 2 (5%)</label>
                        <input type="number" id="m-k2" class="w-full bg-transparent text-lg font-bold outline-none mt-1" placeholder="0">
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-xl">
                        <label class="text-[10px] font-bold opacity-50 uppercase">HP4 Interpersonal (10%)</label>
                        <input type="number" id="m-hp4" class="w-full bg-transparent text-lg font-bold outline-none mt-1" placeholder="0">
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-xl">
                        <label class="text-[10px] font-bold opacity-50 uppercase">HP5 Komunikasi (10%)</label>
                        <input type="number" id="m-hp5" class="w-full bg-transparent text-lg font-bold outline-none mt-1" placeholder="0">
                    </div>
                </div>

                <div class="bg-slate-800/50 p-6 rounded-2xl border border-white/5 space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black text-yellow-500 uppercase">Amali II (HP3 - 25%)</h3>
                        <div class="text-2xl font-black"><span id="m-hp3-total">0.0</span> <span class="text-sm opacity-50">/ 25</span></div>
                    </div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Kecergasan</span><span id="v-s1">0</span></div><input type="range" id="s1" min="0" max="3" step="0.1" value="0" oninput="calcHP3()" class="w-full"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Pemakanan</span><span id="v-s2">0</span></div><input type="range" id="s2" min="0" max="4" step="0.1" value="0" oninput="calcHP3()" class="w-full"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Kembara</span><span id="v-s3">0</span></div><input type="range" id="s3" min="0" max="4" step="0.1" value="0" oninput="calcHP3()" class="w-full"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Keyakinan Air</span><span id="v-s4">0</span></div><input type="range" id="s4" min="0" max="2" step="0.1" value="0" oninput="calcHP3()" class="w-full"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Rakit/Kayak</span><span id="v-s5">0</span></div><input type="range" id="s5" min="0" max="6" step="0.1" value="0" oninput="calcHP3()" class="w-full"></div>
                    <div><div class="flex justify-between text-[10px] mb-1"><span>Tali Tinggi</span><span id="v-s6">0</span></div><input type="range" id="s6" min="0" max="6" step="0.1" value="0" oninput="calcHP3()" class="w-full"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900/50 p-4 rounded-xl">
                        <label class="text-[10px] font-bold opacity-50 uppercase">HP8 Individu (15%)</label>
                        <input type="number" id="m-hp8i" class="w-full bg-transparent text-lg font-bold outline-none mt-1" placeholder="0">
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-xl">
                        <label class="text-[10px] font-bold opacity-50 uppercase">HP8 Kumpulan (30%)</label>
                        <input type="number" id="m-hp8k" class="w-full bg-transparent text-lg font-bold outline-none mt-1" placeholder="0">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-red-500/10 p-4 rounded-xl border border-red-500/20">
                        <label class="text-[10px] font-bold text-red-500 uppercase">Demerit (Penalti)</label>
                        <input type="number" id="m-demerit" class="w-full bg-transparent text-lg font-bold outline-none text-red-500 mt-1" placeholder="0">
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-xl">
                        <label class="text-[10px] font-bold opacity-50 uppercase">Catatan</label>
                        <input type="text" id="m-catatan" class="w-full bg-transparent text-sm font-bold outline-none mt-1" placeholder="Komen prestasi...">
                    </div>
                </div>

                <button onclick="saveMarking()" class="w-full bg-yellow-500 text-black p-5 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-[1.02] transition-all">Sahkan Markah Pelajar</button>
            </div>
        </div>
    </div>

    <script>
        // MASUKKAN URL API TETAP ANDA
        const API_URL = "https://script.google.com/macros/s/AKfycbxfaG5VInNW0Yu16mqTVI-RcdbTNBEqxelA3TBvcjYDRPh96iYacnOmxolOzbgi3Yu9/exec";
        
        let userProfile = null;
        let assignedStudents = [];
        let selectedStudentIC = null;

        function toggleLoad(show) { document.getElementById('loading').classList.toggle('hidden', !show); }

        async function auth(type) {
            const id = document.getElementById('user-id').value;
            const pw = document.getElementById('user-pass').value;
            if(!id) return alert("Sila masukkan IC atau Email anda!");
            
            toggleLoad(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow', 
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ 
                        action: type === 'lecturer' ? 'login_lecturer' : 'login_student', 
                        email: id, no_kp: id, password: pw 
                    })
                });
                
                const d = await response.json();
                toggleLoad(false);

                if(d.result === 'success') {
                    document.getElementById('screen-login').classList.add('hidden');
                    
                    if(type === 'student') {
                        userProfile = d.data.profile;
                        document.getElementById('screen-student').classList.remove('hidden');
                        
                        document.getElementById('profile-pic').src = userProfile[6] || "https://www.w3schools.com/howto/img_avatar.png";
                        document.getElementById('std-img-url').value = userProfile[6] || "";
                        document.getElementById('std-siri').value = userProfile[7] || "4";
                        document.getElementById('std-kump').value = userProfile[8] || "GREY";
                        document.getElementById('std-no').value = userProfile[9] || "";
                        document.getElementById('std-alahan').value = userProfile[10] || "";
                        document.getElementById('std-ubat').value = userProfile[11] || "";
                        document.getElementById('std-sos').value = userProfile[12] || "";
                        
                        alert("Selamat Datang, " + userProfile[1] + "!");
                    } else { 
                        // PAPARAN PENSYARAH
                        document.getElementById('screen-lecturer').classList.remove('hidden');
                        document.getElementById('lec-name-disp').innerText = d.data.name;
                        assignedStudents = d.data.students;
                        
                        // Isi data ke dalam Dropdown Filter secara automatik
                        populateFilters();
                        // Papar semua pelajar pada mulanya
                        filterStudents();
                    }
                } else { alert("RALAT: " + d.message); }
            } catch(e) { 
                toggleLoad(false);
                alert("Gagal menghubungi pangkalan data."); 
            }
        }

        // FUNGSI SIMPAN PELAJAR
        async function updateStudent() {
            toggleLoad(true);
            const payload = {
                action: "full_update_student", 
                no_kp: userProfile[3], 
                url_img: document.getElementById('std-img-url').value,
                siri: document.getElementById('std-siri').value,
                kump: document.getElementById('std-kump').value,
                no_kump: document.getElementById('std-no').value,
                alahan: document.getElementById('std-alahan').value,
                ubat: document.getElementById('std-ubat').value,
                sos: document.getElementById('std-sos').value
            };
            try {
                const response = await fetch(API_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(payload) });
                const d = await response.json();
                toggleLoad(false);
                alert(d.message);
            } catch(e) { toggleLoad(false); alert("Ralat Simpan Data!"); }
        }

        // FUNGSI ISI DROP DOWN FILTER SECARA AUTOMATIK
        function populateFilters() {
            const siris = new Set();
            const kelas = new Set();
            const kumps = new Set();

            // Ekstrak data unik dari senarai pelajar
            assignedStudents.slice(1).forEach(s => {
                if(s[7]) siris.add(s[7]); // Siri
                if(s[5]) kelas.add(s[5]); // Kelas
                if(s[8]) kumps.add(s[8]); // Kumpulan
            });

            const siriSel = document.getElementById('filter-siri');
            siriSel.innerHTML = '<option value="ALL">SEMUA SIRI</option>';
            [...siris].sort().forEach(v => siriSel.innerHTML += `<option value="${v}">${v}</option>`);

            const kelasSel = document.getElementById('filter-kelas');
            kelasSel.innerHTML = '<option value="ALL">SEMUA KELAS</option>';
            [...kelas].sort().forEach(v => kelasSel.innerHTML += `<option value="${v}">${v}</option>`);

            const kumpSel = document.getElementById('filter-kump');
            kumpSel.innerHTML = '<option value="ALL">SEMUA KUMPULAN</option>';
            [...kumps].sort().forEach(v => kumpSel.innerHTML += `<option value="${v}">${v}</option>`);
        }

        // FUNGSI TAPIS PELAJAR APABILA DROPDOWN DITUKAR
        function filterStudents() {
            const fSiri = document.getElementById('filter-siri').value;
            const fKelas = document.getElementById('filter-kelas').value;
            const fKump = document.getElementById('filter-kump').value;

            const sel = document.getElementById('sel-std');
            sel.innerHTML = '<option value="">-- PILIH PELAJAR --</option>';

            assignedStudents.slice(1).forEach(s => {
                const matchSiri = (fSiri === 'ALL' || String(s[7]) === String(fSiri));
                const matchKelas = (fKelas === 'ALL' || String(s[5]) === String(fKelas));
                const matchKump = (fKump === 'ALL' || String(s[8]) === String(fKump));

                if (matchSiri && matchKelas && matchKump) {
                    let label = `NO ${s[9]||'-'} | ${s[5]||'-'} | ${s[1]}`;
                    sel.innerHTML += `<option value="${s[3]}">${label.toUpperCase()}</option>`;
                }
            });

            // Sembunyikan borang markah apabila penapis ditukar
            document.getElementById('marking-panel').classList.add('hidden');
            document.getElementById('lec-std-info').classList.add('hidden');
            document.getElementById('lec-std-pic').src = "https://www.w3schools.com/howto/img_avatar.png";
            selectedStudentIC = null;
        }

        // FUNGSI JURULATIH LOAD PELAJAR & MARKAH
        function loadStudentMarking() {
            const ic = document.getElementById('sel-std').value;
            if(!ic) {
                document.getElementById('marking-panel').classList.add('hidden');
                document.getElementById('lec-std-info').classList.add('hidden');
                document.getElementById('lec-std-pic').src = "https://www.w3schools.com/howto/img_avatar.png";
                selectedStudentIC = null;
                return;
            }
            
            const s = assignedStudents.find(student => student[3] === ic);
            if(!s) return;

            selectedStudentIC = ic; 
            
            document.getElementById('marking-panel').classList.remove('hidden');
            document.getElementById('lec-std-info').classList.remove('hidden');
            document.getElementById('lec-std-pic').src = s[6] || "https://www.w3schools.com/howto/img_avatar.png";
            document.getElementById('info-ic').innerText = "IC: " + s[3];
            document.getElementById('info-kump').innerText = `SIRI ${s[7]||'-'} | KUMP ${s[8]||'-'} | NO ${s[9]||'-'}`;

            document.getElementById('m-k1').value = s[11] || "";
            document.getElementById('m-k2').value = s[12] || "";
            document.getElementById('m-hp4').value = s[13] || "";
            document.getElementById('m-hp5').value = s[14] || "";
            document.getElementById('m-hp3-total').innerText = s[15] || "0.0"; 
            document.getElementById('m-hp8i').value = s[16] || "";
            document.getElementById('m-hp8k').value = s[17] || "";
            document.getElementById('m-demerit').value = s[18] || "";
            document.getElementById('m-catatan').value = s[22] || "";
            
            for(let i=1; i<=6; i++) {
                document.getElementById('s'+i).value = 0;
                document.getElementById('v-s'+i).innerText = "0";
            }
        }

        function calcHP3() {
            let sum = 0;
            for(let i=1; i<=6; i++) {
                let v = parseFloat(document.getElementById('s'+i).value);
                document.getElementById('v-s'+i).innerText = v.toFixed(1);
                sum += v;
            }
            document.getElementById('m-hp3-total').innerText = sum.toFixed(1);
        }

        // FUNGSI JURULATIH SIMPAN MARKAH
        async function saveMarking() {
            if(!selectedStudentIC) return alert("Sila pilih pelajar daripada senarai!");
            toggleLoad(true);
            
            const payload = {
                action: "save_mark",
                no_kp: selectedStudentIC, 
                k1: document.getElementById('m-k1').value,
                k2: document.getElementById('m-k2').value,
                hp4: document.getElementById('m-hp4').value,
                hp5: document.getElementById('m-hp5').value,
                hp3: document.getElementById('m-hp3-total').innerText,
                hp8i: document.getElementById('m-hp8i').value,
                hp8k: document.getElementById('m-hp8k').value,
                demerit: document.getElementById('m-demerit').value,
                catatan: document.getElementById('m-catatan').value
            };

            try {
                const response = await fetch(API_URL, { 
                    method: 'POST', 
                    redirect: 'follow', 
                    headers: { "Content-Type": "text/plain;charset=utf-8" }, 
                    body: JSON.stringify(payload) 
                });
                const d = await response.json();
                toggleLoad(false);
                if(d.result === 'success') {
                    alert("TAHNIAH! " + d.message); 
                } else { alert("RALAT: " + d.message); }
            } catch(e) { toggleLoad(false); alert("Ralat Simpan Markah!"); }
        }
    </script>
</body>
</html>
